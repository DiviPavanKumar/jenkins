// Roboshop-catalogue service Jenkins pipeline

pipeline {
    agent { label 'AGENT-1' }

    environment { 
        AWS_ACCOUNT_ID = "069233348386"
        AWS_REGION     = "us-east-1"
        REPO_NAME      = "roboshop/catalogue"
        PROJECT = "roboshop"
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds() 
    }

    parameters {
        booleanParam(name: 'deploy', defaultValue: false, description: 'Toggle this value')
    }

    stages {
        stage('Read package.json') {
            steps {
                script {
                    sh 'ls -al'
                    def packageJson = readJSON file: 'catalogue/package.json'
                    appVersion = packageJson.version
                    echo "package version: ${appVersion}"
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    cd catalogue
                    npm install --production
                '''
            }
        }

        stage('Docker Build and Push') {
            steps {
                script {
                    withAWS(credentials: 'aws-config', region: "${env.AWS_REGION}") {
                        sh """
                            aws ecr get-login-password --region ${env.AWS_REGION} | \
                              docker login --username AWS --password-stdin ${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com

                            docker build -t ${env.REPO_NAME}:${appVersion} ./catalogue

                            docker tag ${env.REPO_NAME}:${appVersion} \
                              ${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/${env.REPO_NAME}:${appVersion}

                            docker push ${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/${env.REPO_NAME}:${appVersion}
                        """
                    }
                }
            }
        }

        stage('Trigger Deploy') {
            when {
                expression { params.deploy }
            }
            steps {
                script {
                    build job: 'catalogue-cd',
                    parameters: [
                        string(name: 'appVersion', value: "${appVersion}"),
                        string(name: 'deploy_to', value: 'dev')
                    ],
                    propagate: false,
                    wait: false
                }
            }
        }
    }

    post {
        always {
            echo "Always say Hi"
            deleteDir()
        }
        success {
            echo "Pipeline is Success"
        }
        failure {
            echo "Pipeline has Failed"
        }
    }
}
